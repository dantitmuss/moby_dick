{% extends "base.html" %}

{% block title %}Home | Moby Dick Verse Finder{% endblock %}

{% block content %}
  <!-- Test block to verify Tailwind is active -->
  <div class="bg-red-400 text-blue-900 p-4 rounded text-2xl mb-6">
    ðŸ”¥ If you can see THIS red box, Tailwind is working!
  </div>

  <!-- Main Heading -->
  <h2 class="text-2xl font-bold mb-4">Moby Dick Semantic Verse Search</h2>

  <!-- Search Form -->
  <div class="bg-white p-6 rounded shadow-md mb-6">
    <form action="/search" method="post">
      <label for="query" class="block mb-2 font-semibold">
        Enter a theme, emotion, or idea:
      </label>
      <input type="text" name="query" id="query" placeholder="e.g., dread, revenge, the sea" 
             class="w-full p-3 border rounded mb-4" required>
      <button type="submit" class="bg-blue-700 text-white px-4 py-2 rounded hover:bg-blue-800 transition">
        Submit
      </button>
    </form>
  </div>

  <hr class="my-6">

  <!-- Tag Search Form -->
  <h2 class="text-xl font-bold mb-4">Or search by tag</h2>
  <div class="bg-white p-6 rounded shadow-md">
    <form action="/tag_search" method="post">
      <label for="category" class="block mb-2 font-semibold">
        Choose a tag category:
      </label>
      <select name="category" id="category" onchange="updateTags()" required
              class="w-full p-2 border rounded mb-4">
        <option value="">--Select Category--</option>
        <option value="entities">Entities</option>
        <option value="themes">Themes</option>
        <option value="symbolism">Symbolism</option>
        <option value="feeling">Feeling</option>
        <option value="vibe">Vibe</option>
        <option value="literary_motifs">Literary Motifs</option>
      </select>

      <label for="tag" class="block mb-2 font-semibold">
        Choose a tag:
      </label>
      <input id="tag" name="tag" class="awesomplete w-full p-2 border rounded mb-4" placeholder="Start typing..." required>
      <button type="submit" class="bg-blue-700 text-white px-4 py-2 rounded hover:bg-blue-800 transition">
        Search by Tag
      </button>
    </form>
  </div>

  <!-- Awesomplete Script (can be kept here if it's page-specific) -->
  <script>
    let tagsData = {};
    let awesompleteInstance = null;

    // âœ… 1. Define the helper function (can go here)
    function getRandomSubset(array, n) {
        const shuffled = array.slice().sort(() => 0.5 - Math.random());
        return shuffled.slice(0, n);
    }

    // âœ… 2. Fetch tags.json
    fetch('/tags.json')
        .then(response => response.json())
        .then(data => {
            tagsData = data;
        })
        .catch(error => {
            console.error("Failed to load tags.json:", error);
        });

    // âœ… 3. Main function that runs on category change
    function updateTags() {
    const categorySelect = document.getElementById("category");
    const tagInput = document.getElementById("tag");
    const selectedCategory = categorySelect.value;

    tagInput.value = "";

    if (tagsData[selectedCategory]) {
        if (awesompleteInstance) {
            // Clear the list for new category
            awesompleteInstance.list = [];
        }
        else {
            awesompleteInstance = new Awesomplete(tagInput, {
                list: [],
                minChars: 1,
                autoFirst: true,
                maxItems: 100,
                filter: function(text, input) {
                    const words = text.toLowerCase().split(/\s+/);
                    const loweredInput = input.toLowerCase();
                    return words.some(word => word.startsWith(loweredInput));
                }
            });
            // When the field is focused, show a random subset
            tagInput.addEventListener("focus", function () {
                if (tagsData[selectedCategory]) {
                    awesompleteInstance.list = getRandomSubset(tagsData[selectedCategory], 10);
                    awesompleteInstance.evaluate();
                }
            });
            // NEW: When the user types, use the full list for filtering
            tagInput.addEventListener("input", function() {
                if (tagInput.value.length > 0 && tagsData[selectedCategory]) {
                    awesompleteInstance.list = tagsData[selectedCategory].sort((a, b) =>
                        a.toLowerCase().localeCompare(b.toLowerCase())
                    );
                    awesompleteInstance.evaluate();
                }
            });
          }
        }
      }

      // Optional: Auto-submit when tag selected
      document.getElementById("tag").addEventListener("awesomplete-selectcomplete", function () {
         this.form.submit();
      });
  </script>

{% endblock %}
