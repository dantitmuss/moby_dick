{% extends "base.html" %}

{% block title %}The Moby Dick Bible: Find Quotes & Meaning in The Whale{% endblock %}

{% block content %}

  <!-- Main Heading -->
  <h1 class="text-2xl font-bold mb-4">Moby Dick Semantic Verse Search</h2>

  <!-- Information -->
  <div class="bg-white p-6 rounded shadow-md mb-6">
   <h2 class="text-xl font-bold mb-4">A Scripture of Salt and Ink</h2>
    <p>
      Moby-Dick is vast. Within its pages, there are storms and sermons, laughter, silence, and the long ache of meaning. It’s a book that holds everything: the sacred and the profane, the celestial and the sea-soaked.
    </p>
    <br>
    <p>
      The Moby Dick Bible begins with a newly written verse in Melville’s voice—strange, solemn, searching. Then it finds a passage from the book that speaks to what you’ve asked. What are you looking for?
    </p>
    <br>
    <p>
      The feeling of Tuesday afternoons?
      The nature of regret?
      Whether cats know they’re being annoying?
    </p>
    <br>
    <p class="font-extrabold">
      Ask the Whale. It may answer.
    </p>
  </div>



  <!-- Search Form -->
  <div class="bg-white p-6 rounded shadow-md mb-6">
    <form action="/search" method="post">
      <label for="query" class="block mb-2 font-semibold">
        Enter a theme, emotion, or idea:
      </label>
      <input type="text" name="query" id="query" placeholder="e.g. dread, adventure, The Bachelor franchise..." 
             class="w-full p-3 border rounded mb-4" required>
      <button type="submit" class="bg-blue-700 text-white px-4 py-2 rounded hover:bg-blue-800 transition">
        Submit
      </button>
    </form>
  </div>

  <hr class="my-6">

  <!-- Tag Search Form -->
  <h2 class="text-xl font-bold mb-4">Or search by tag</h2>
  <div class="bg-white p-6 rounded shadow-md">
    <form action="/tag_search" method="post">
      <label for="category" class="block mb-2 font-semibold">
        Choose a tag category:
      </label>
      <select name="category" id="category" onchange="updateTags()" required
              class="w-full p-2 border rounded mb-4">
        <option value="">--Select Category--</option>
        <option value="entities">Entities</option>
        <option value="themes">Themes</option>
        <option value="symbolism">Symbolism</option>
        <option value="feeling">Feeling</option>
        <option value="vibe">Vibe</option>
        <option value="literary_motifs">Literary Motifs</option>
      </select>

      <label for="tag" class="block mb-2 font-semibold">
        Choose a tag:
      </label>
      <input id="tag" name="tag" class="awesomplete w-full p-2 border rounded mb-4" placeholder="Start typing..." required>
      <button type="submit" class="bg-blue-700 text-white px-4 py-2 rounded hover:bg-blue-800 transition">
        Search by Tag
      </button>
    </form>
  </div>

  <!-- Awesomplete Script (can be kept here if it's page-specific) -->
  <script>
    let tagsData = {};
    let awesompleteInstance = null;

    // ✅ 1. Define the helper function (can go here)
    function getRandomSubset(array, n) {
        const shuffled = array.slice().sort(() => 0.5 - Math.random());
        return shuffled.slice(0, n);
    }

    // ✅ 2. Fetch tags.json
    fetch('/tags.json')
      .then(response => response.json())
      .then(data => {
        tagsData = data;
      })
      .catch(error => {
        console.error("Failed to load tags.json:", error);
      });

    // ✅ 3. Main function that runs on category change
    function updateTags() {
    const categorySelect = document.getElementById("category");
    const tagInput = document.getElementById("tag");
    const selectedCategory = categorySelect.value;

    tagInput.value = "";

    if (tagsData[selectedCategory]) {
      if (awesompleteInstance) {
        // Clear the list for new category
        awesompleteInstance.list = [];
      }
      else {
        awesompleteInstance = new Awesomplete(tagInput, {
          list: [],
          minChars: 1,
          autoFirst: true,
          maxItems: 100,
          filter: function(text, input) {
            const words = text.toLowerCase().split(/\s+/);
            const loweredInput = input.toLowerCase();
            return words.some(word => word.startsWith(loweredInput));
            }
          });
        // When the field is focused, show a random subset
        tagInput.addEventListener("focus", function () {
          if (tagsData[selectedCategory]) {
            awesompleteInstance.list = getRandomSubset(tagsData[selectedCategory], 10);
            awesompleteInstance.evaluate();
            }
          });
          // NEW: When the user types, use the full list for filtering
          tagInput.addEventListener("input", function() {
            if (tagInput.value.length > 0 && tagsData[selectedCategory]) {
              awesompleteInstance.list = tagsData[selectedCategory].sort((a, b) =>
              a.toLowerCase().localeCompare(b.toLowerCase())
                );
              awesompleteInstance.evaluate();
              }
            });
          }
        }
      }

      // Optional: Auto-submit when tag selected
      document.getElementById("tag").addEventListener("awesomplete-selectcomplete", function () {
         this.form.submit();
      });
  </script>

{% endblock %}
